(function(){function b(){var a={};this.on=function(m,b){a[m]=b};this.emit=function(m){var b=a[m];b&&b.apply(null,Array.prototype.slice.call(arguments,1))}}function i(a){b.call(this);a.quality=a.quality/100||0.8;this.settings=a;this.encoder=new Whammy.Video(a.framerate,a.quality)}function d(a){b.call(this);a.quality=a.quality/100||0.8;this.settings=a;this.encoder=new FFMpegServer.Video(a);this.encoder.on("process",function(){this.emit("process")}.bind(this));this.encoder.on("finished",function(a,b){var d=
this.callback;d&&(this.callback=void 0,d(a,b))}.bind(this));this.encoder.on("progress",function(a){if(this.settings.onProgress)this.settings.onProgress(a)}.bind(this));this.encoder.on("error",function(a){alert(JSON.stringify(a,null,2))}.bind(this))}function j(a){b.call(this);a.quality=31-(30*a.quality/100||10);a.workers=a.workers||4;this.settings=a;this.canvas=document.createElement("canvas");this.ctx=this.canvas.getContext("2d");this.sizeSet=!1;this.encoder=new GIF({workers:a.workers,quality:a.quality,
workerScript:a.workersPath+"gif.worker.js"});this.encoder.on("progress",function(a){if(this.settings.onProgress)this.settings.onProgress(a)}.bind(this));this.encoder.on("finished",function(a){var b=this.callback;b&&(this.callback=void 0,b(URL.createObjectURL(a)))}.bind(this))}var z=window.Date.now();b.start=function(){};b.stop=function(){};b.add=function(){};b.save=function(){};b.safeToProceed=function(){return!0};i.prototype=Object.create(b);i.prototype.add=function(a){this.encoder.add(a)};i.prototype.save=
function(a){var b=this.encoder.compile(),b=new Blob([b],{type:"octet/stream"}),b=window.URL.createObjectURL(b);a(b)};d.prototype=Object.create(b);d.prototype.start=function(){this.encoder.start(this.settings)};d.prototype.add=function(a){this.encoder.add(a)};d.prototype.save=function(a){this.callback=a;this.encoder.end()};d.prototype.safeToProceed=function(){return this.encoder.safeToProceed()};j.prototype=Object.create(b);j.prototype.add=function(a){this.sizeSet||(this.encoder.setOption("width",
a.width),this.encoder.setOption("height",a.height),this.sizeSet=!0);this.canvas.width=a.width;this.canvas.height=a.height;this.ctx.drawImage(a,0,0);this.encoder.addFrame(this.ctx,{copy:!0,delay:this.settings.step})};j.prototype.save=function(a){this.callback=a;this.encoder.render()};window.CCapture=function(a){function b(){k||(k=!0,q(p,10))}function y(){function a(){this._hooked||(this._hooked=!0,this._hookedTime=this.currentTime,this.pause(),s.push(this));return this._hookedTime}h("Capturer start");
e=window.Date.now();l=window.performance.now();window.Date.prototype.getTime=function(){return e};window.Date.now=function(){return e};window.setTimeout=function(a,r){var c={callback:a,time:r,triggerTime:e+r};f.push(c);h("Timeout set to "+c.time);b();return c};window.clearTimeout=function(a){for(var b=0;b<f.length;b++)f[b]==a&&(f.splice(b,1),h("Timeout cleared"))};window.requestAnimationFrame=function(a){n=a;b()};window.performance.now=function(){return l};Object.defineProperty(HTMLVideoElement.prototype,
"currentTime",{get:a});Object.defineProperty(HTMLAudioElement.prototype,"currentTime",{get:a})}function p(){if(k&&g.safeToProceed()){k=!1;e+=c.step;l+=c.step;s.forEach(function(a){a._hookedTime+=c.step});t++;h("Frame: "+t);for(var a=0;a<f.length;a++)e>=f[a].triggerTime&&(f[a].callback(),console.log("timeout!"),f.splice(a,1));if(a=n)n=null,a(e-z)}}function h(a){u&&console.log(a)}function A(a){var b=v[a];b&&b.apply(null,Array.prototype.slice.call(arguments,1))}var c=a||{},u,e,l,g,f=[],t=0,n=null,o=
!1,k=!1,v={};c.framerate=c.framerate||60;u=c.verbose||!1;c.step=1E3/c.framerate;h("Step is set to "+c.step+"ms");var a={gif:j,webm:i,ffmpegserver:d},w=a[c.format];if(!w)throw"Error: Incorrect or missing format: Valid formats are "+Object.keys(a).join(", ");g=new w(c);g.on("process",p);g.on("progress",function(a){A("progess",a)});!1=="performance"in window&&(window.performance={});Date.now=Date.now||function(){return(new Date).getTime()};if(!1=="now"in window.performance){var x=Date.now();performance.timing&&
performance.timing.navigationStart&&(x=performance.timing.navigationStart);window.performance.now=function(){return Date.now()-x}}var q=window.setTimeout,B=window.clearTimeout,C=window.requestAnimationFrame,D=window.Date.now,E=window.performance.now,F=window.Date.prototype.getTime,s=[];return{start:function(){y();g.start();o=!0},capture:function(a){o&&g.add(a)},stop:function(){o=!1;g.stop();h("Capturer stop");window.setTimeout=q;window.clearTimeout=B;window.requestAnimationFrame=C;window.Date.prototype.getTime=
F;window.Date.now=D;window.performance.now=E},save:function(a){g.save(a)},on:function(a,b){v[a]=b}}}})();
