(function(){function b(){var a={};this.on=function(k,b){a[k]=b};this.emit=function(k){var b=a[k];b&&b.apply(null,Array.prototype.slice.call(arguments,1))}}function i(a){b.call(this);a.quality=a.quality/100||0.8;this.settings=a;this.encoder=new Whammy.Video(a.framerate,a.quality)}function c(a){b.call(this);a.quality=a.quality/100||0.8;this.settings=a;this.encoder=new FFMpegServer.Video(a);this.encoder.on("process",function(){this.emit("process")}.bind(this));this.encoder.on("finished",function(a,b){var c=
this.callback;c&&(this.callback=void 0,c(a,b))}.bind(this));this.encoder.on("progress",function(a){if(this.settings.onProgress)this.settings.onProgress(a)}.bind(this));this.encoder.on("error",function(a){alert(JSON.stringify(a,null,2))}.bind(this))}function j(a){b.call(this);a.quality=31-(30*a.quality/100||10);a.workers=a.workers||4;this.settings=a;this.canvas=document.createElement("canvas");this.ctx=this.canvas.getContext("2d");this.sizeSet=!1;this.encoder=new GIF({workers:a.workers,quality:a.quality,
workerScript:a.workersPath+"gif.worker.js"});this.encoder.on("progress",function(a){if(this.settings.onProgress)this.settings.onProgress(a)}.bind(this));this.encoder.on("finished",function(a){var b=this.callback;b&&(this.callback=void 0,b(URL.createObjectURL(a)))}.bind(this))}b.start=function(){};b.stop=function(){};b.add=function(){};b.save=function(){};b.safeToProceed=function(){return!0};i.prototype=Object.create(b);i.prototype.add=function(a){this.encoder.add(a)};i.prototype.save=function(a){var b=
this.encoder.compile(),b=new Blob([b],{type:"octet/stream"}),b=window.URL.createObjectURL(b);a(b)};c.prototype=Object.create(b);c.prototype.start=function(){this.encoder.start(this.settings)};c.prototype.add=function(a){this.encoder.add(a)};c.prototype.save=function(a){this.callback=a;this.encoder.end()};c.prototype.safeToProceed=function(){return this.encoder.safeToProceed()};j.prototype=Object.create(b);j.prototype.add=function(a){this.sizeSet||(this.encoder.setOption("width",a.width),this.encoder.setOption("height",
a.height),this.sizeSet=!0);this.canvas.width=a.width;this.canvas.height=a.height;this.ctx.drawImage(a,0,0);this.encoder.addFrame(this.ctx,{copy:!0,delay:this.settings.step})};j.prototype.save=function(a){this.callback=a;this.encoder.render()};window.CCapture=function(a){function b(){l||(l=!0,p(o,16))}function v(){h("Capturer start");g=window.Date.now();window.Date.prototype.getTime=function(){return g};window.Date.now=function(){return g};window.setTimeout=function(a,q){var c={callback:a,time:q,triggerTime:g+
q};e.push(c);h("Timeout set to "+c.time);b();return c};window.clearTimeout=function(a){for(var b=0;b<e.length;b++)e[b]==a&&(e.splice(b,1),h("Timeout cleared"))};window.requestAnimationFrame=function(a){m=a;b()}}function o(){l=!1;if(f.safeToProceed()){g+=d.step;r++;h("Frame: "+r);for(var a=0;a<e.length;a++)g>=e[a].triggerTime&&(e[a].callback(),console.log("timeout!"),e.splice(a,1));if(a=m)m=null,a()}}function h(a){s&&console.log(a)}function w(a){var b=t[a];b&&b.apply(null,Array.prototype.slice.call(arguments,
1))}var d=a||{},s,g,f,e=[],r=0,m=null,n=!1,l=!1,t={};d.framerate=d.framerate||60;s=d.verbose||!1;d.step=1E3/d.framerate;h("Step is set to "+d.step+"ms");var a={gif:j,webm:i,ffmpegserver:c},u=a[d.format];if(!u)throw"Error: Incorrect or missing format: Valid formats are "+Object.keys(a).join(", ");f=new u(d);f.on("process",o);f.on("progress",function(a){w("progess",a)});var p=window.setTimeout,x=window.clearTimeout,y=window.requestAnimationFrame,z=window.Date.now,A=window.Date.prototype.getTime;return{start:function(){v();
f.start();n=!0},capture:function(a){n&&f.add(a)},stop:function(){n=!1;f.stop();h("Capturer stop");window.setTimeout=p;window.clearTimeout=x;window.requestAnimationFrame=y;window.Date.prototype.getTime=A;window.Date.now=z},save:function(a){f.save(a)},on:function(a,b){t[a]=b}}}})();
