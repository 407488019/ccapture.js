(function(){function b(){var a={};this.on=function(l,b){a[l]=b};this.emit=function(l){var b=a[l];b&&b.apply(null,Array.prototype.slice.call(arguments,1))}}function i(a){b.call(this);a.quality=a.quality/100||0.8;this.settings=a;this.encoder=new Whammy.Video(a.framerate,a.quality)}function c(a){b.call(this);a.quality=a.quality/100||0.8;this.settings=a;this.encoder=new FFMpegServer.Video(a);this.encoder.on("process",function(){this.emit("process")}.bind(this));this.encoder.on("finished",function(a,b){var c=
this.callback;c&&(this.callback=void 0,c(a,b))}.bind(this));this.encoder.on("progress",function(a){if(this.settings.onProgress)this.settings.onProgress(a)}.bind(this));this.encoder.on("error",function(a){alert(JSON.stringify(a,null,2))}.bind(this))}function j(a){b.call(this);a.quality=31-(30*a.quality/100||10);a.workers=a.workers||4;this.settings=a;this.canvas=document.createElement("canvas");this.ctx=this.canvas.getContext("2d");this.sizeSet=!1;this.encoder=new GIF({workers:a.workers,quality:a.quality,
workerScript:a.workersPath+"gif.worker.js"});this.encoder.on("progress",function(a){if(this.settings.onProgress)this.settings.onProgress(a)}.bind(this));this.encoder.on("finished",function(a){var b=this.callback;b&&(this.callback=void 0,b(URL.createObjectURL(a)))}.bind(this))}var w=window.Date.now();b.start=function(){};b.stop=function(){};b.add=function(){};b.save=function(){};b.safeToProceed=function(){return!0};i.prototype=Object.create(b);i.prototype.add=function(a){this.encoder.add(a)};i.prototype.save=
function(a){var b=this.encoder.compile(),b=new Blob([b],{type:"octet/stream"}),b=window.URL.createObjectURL(b);a(b)};c.prototype=Object.create(b);c.prototype.start=function(){this.encoder.start(this.settings)};c.prototype.add=function(a){this.encoder.add(a)};c.prototype.save=function(a){this.callback=a;this.encoder.end()};c.prototype.safeToProceed=function(){return this.encoder.safeToProceed()};j.prototype=Object.create(b);j.prototype.add=function(a){this.sizeSet||(this.encoder.setOption("width",
a.width),this.encoder.setOption("height",a.height),this.sizeSet=!0);this.canvas.width=a.width;this.canvas.height=a.height;this.ctx.drawImage(a,0,0);this.encoder.addFrame(this.ctx,{copy:!0,delay:this.settings.step})};j.prototype.save=function(a){this.callback=a;this.encoder.render()};window.CCapture=function(a){function b(){k||(k=!0,p(o,16))}function v(){h("Capturer start");e=window.Date.now();window.Date.prototype.getTime=function(){return e};window.Date.now=function(){return e};window.setTimeout=
function(a,q){var c={callback:a,time:q,triggerTime:e+q};f.push(c);h("Timeout set to "+c.time);b();return c};window.clearTimeout=function(a){for(var b=0;b<f.length;b++)f[b]==a&&(f.splice(b,1),h("Timeout cleared"))};window.requestAnimationFrame=function(a){m=a;b()}}function o(){if(k&&g.safeToProceed()){k=!1;e+=d.step;r++;h("Frame: "+r);for(var a=0;a<f.length;a++)e>=f[a].triggerTime&&(f[a].callback(),console.log("timeout!"),f.splice(a,1));if(a=m)m=null,a(e-w)}}function h(a){s&&console.log(a)}function x(a){var b=
t[a];b&&b.apply(null,Array.prototype.slice.call(arguments,1))}var d=a||{},s,e,g,f=[],r=0,m=null,n=!1,k=!1,t={};d.framerate=d.framerate||60;s=d.verbose||!1;d.step=1E3/d.framerate;h("Step is set to "+d.step+"ms");var a={gif:j,webm:i,ffmpegserver:c},u=a[d.format];if(!u)throw"Error: Incorrect or missing format: Valid formats are "+Object.keys(a).join(", ");g=new u(d);g.on("process",o);g.on("progress",function(a){x("progess",a)});var p=window.setTimeout,y=window.clearTimeout,z=window.requestAnimationFrame,
A=window.Date.now,B=window.Date.prototype.getTime;return{start:function(){v();g.start();n=!0},capture:function(a){n&&g.add(a)},stop:function(){n=!1;g.stop();h("Capturer stop");window.setTimeout=p;window.clearTimeout=y;window.requestAnimationFrame=z;window.Date.prototype.getTime=B;window.Date.now=A},save:function(a){g.save(a)},on:function(a,b){t[a]=b}}}})();
