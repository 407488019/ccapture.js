function CCFrameEncoder(){}CCFrameEncoder.start=function(){};CCFrameEncoder.stop=function(){};CCFrameEncoder.add=function(){};CCFrameEncoder.save=function(){};function CCWebMEncoder(a){CCFrameEncoder.call(this);a.quality=a.quality||0.8;this.settings=a;this.encoder=new Whammy.Video(a.framerate,a.quality)}CCWebMEncoder.prototype=Object.create(CCFrameEncoder);CCWebMEncoder.prototype.add=function(a){this.encoder.add(a)};
CCWebMEncoder.prototype.save=function(a){var c=this.encoder.compile(),c=new Blob([c],{type:"octet/stream"}),c=window.URL.createObjectURL(c);a(c)};function CCGIFEncoder(a){CCFrameEncoder.call(this);a.quality=a.quality||6;a.workers=a.workers||4;this.settings=a;this.canvas=document.createElement("canvas");this.ctx=this.canvas.getContext("2d");this.sizeSet=!1;this.encoder=new GIF({workers:a.workers,quality:a.quality,workerScript:a.workersPath+"gif.worker.js"})}CCGIFEncoder.prototype=Object.create(CCFrameEncoder);
CCGIFEncoder.prototype.add=function(a){this.sizeSet||(this.encoder.setOption("width",a.width),this.encoder.setOption("height",a.height),this.sizeSet=!0);this.canvas.width=a.width;this.canvas.height=a.height;this.ctx.drawImage(a,0,0);this.encoder.addFrame(this.ctx,{copy:!0,delay:this.settings.step})};CCGIFEncoder.prototype.save=function(a){this.encoder.on("finished",function(c){a(URL.createObjectURL(c))});if(this.settings.onProgress)this.encoder.on("progress",this.settings.onProgress);this.encoder.render()};
function CCapture(a){function c(){f("Capturer start");e=Date.now();Date.prototype.getTime=function(){return e};Date.now=function(){return e};setTimeout=function(a,c){var b={callback:a,time:c,triggerTime:e+c};d.push(b);f("Timeout set to "+b.time);return b};clearTimeout=function(a){for(var b=0;b<d.length;b++)d[b]==a&&(d.splice(b,1),f("Timeout cleared"))};requestAnimationFrame=function(a){g=a}}function k(){f("Incrementing time");e+=b.step;l++;for(var a=0;a<d.length;a++)e>=d[a].triggerTime&&(d[a].callback(),
console.log("timeout!"),d.splice(a,1));g&&g()}function f(a){i&&console.log(a)}var b=a||{},i,e,d=[],l=0,g=null,h=!1;b.framerate=b.framerate||60;i=b.verbose||!1;b.step=1E3/b.framerate;switch(b.format){case "gif":_encoder=new CCGIFEncoder(b);break;case "webm":_encoder=new CCWebMEncoder(b);break;default:throw"Error: Format not specified (gif or webm)";}var m=setTimeout,n=clearTimeout,j=requestAnimationFrame,o=Date.now,p=Date.prototype.getTime;return{start:function(){c();_encoder.start();h=!0},capture:function(a){h&&
(_encoder.add(a),j(k))},stop:function(){h=!1;_encoder.stop();f("Capturer stop");setTimeout=m;clearTimeout=n;requestAnimationFrame=j;Date.prototype.getTime=p;Date.now=o},save:function(a){_encoder.save(a)}}};
