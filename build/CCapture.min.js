(function(){function z(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}function c(a){var I={};this.settings=a;this.on=function(a,c){I[a]=c};this.emit=function(a){var c=I[a];c&&c.apply(null,Array.prototype.slice.call(arguments,1))};this.filename=a.name||z();this.mimeType=this.extension=""}function e(a){c.call(this,a);this.extension=".tar";this.mimeType="application/x-tar";this.fileExtension="";this.tape=null;
this.count=0}function A(a){e.call(this,a);this.type="image/png";this.fileExtension=".png"}function B(a){e.call(this,a);this.type="image/jpeg";this.fileExtension=".jpg";this.quality=a.quality/100||0.8}function n(a){"image/webp"!==document.createElement("canvas").toDataURL("image/webp").substr(5,10)&&console.log("WebP not supported - try another export format");c.call(this,a);a.quality=a.quality/100||0.8;this.extension=".webm";this.mimeType="video/webm";this.baseFilename=this.filename;this.frames=[];
this.part=1}function o(a){c.call(this,a);a.quality=a.quality/100||0.8;this.encoder=new FFMpegServer.Video(a);this.encoder.on("process",function(){this.emit("process")}.bind(this));this.encoder.on("finished",function(a,c){var e=this.callback;e&&(this.callback=void 0,e(a,c))}.bind(this));this.encoder.on("progress",function(a){if(this.settings.onProgress)this.settings.onProgress(a)}.bind(this));this.encoder.on("error",function(a){alert(JSON.stringify(a,null,2))}.bind(this))}function x(a){c.call(this,
a);this.framerate=this.settings.framerate;this.type="video/webm";this.extension=".webm";this.mediaRecorder=this.stream=null;this.chunks=[]}function y(a){c.call(this,a);a.quality=31-(30*a.quality/100||10);a.workers=a.workers||4;this.extension=".gif";this.mimeType="image/gif";this.canvas=document.createElement("canvas");this.ctx=this.canvas.getContext("2d");this.sizeSet=!1;this.encoder=new GIF({workers:a.workers,quality:a.quality,workerScript:a.workersPath+"gif.worker.js"});this.encoder.on("progress",
function(a){if(this.settings.onProgress)this.settings.onProgress(a)}.bind(this));this.encoder.on("finished",function(a){var c=this.callback;c&&(this.callback=void 0,c(a))}.bind(this))}function s(a){function c(){function a(){this._hooked||(this._hooked=!0,this._hookedTime=this.currentTime||0,this.pause(),K.push(this));return this._hookedTime+b.startTime}k("Capturer start");C=window.Date.now();l=C+b.startTime;D=window.performance.now();E=D+b.startTime;window.Date.prototype.getTime=function(){return l};
window.Date.now=function(){return l};window.setTimeout=function(a,j){var b={callback:a,time:j,triggerTime:l+j};p.push(b);k("Timeout set to "+b.time);return b};window.clearTimeout=function(a){for(var j=0;j<p.length;j++)p[j]==a&&(p.splice(j,1),k("Timeout cleared"))};window.setInterval=function(a,j){var b={callback:a,time:j,triggerTime:l+j};q.push(b);k("Interval set to "+b.time);return b};window.clearInterval=function(){k("clear Interval");return null};window.requestAnimationFrame=function(a){F.push(a)};
window.performance.now=function(){return E};Object.defineProperty(HTMLVideoElement.prototype,"currentTime",{get:a});Object.defineProperty(HTMLAudioElement.prototype,"currentTime",{get:a})}function e(){G=!1;g.stop();k("Capturer stop");window.setTimeout=v;window.setInterval=H;window.clearTimeout=Q;window.requestAnimationFrame=R;window.Date.prototype.getTime=S;window.Date.now=T;window.performance.now=U}function J(){v(r,0,void 0)}function s(){var a=m/b.framerate;if(b.frameLimit&&m>=b.frameLimit||b.timeLimit&&
a>=b.timeLimit)e(),L();var d=new Date(null);d.setSeconds(a);i.textContent=2<b.motionBlurFrames?"CCapture "+b.format+" | "+m+" frames ("+t+" inter) | "+d.toISOString().substr(11,8):"CCapture "+b.format+" | "+m+" frames | "+d.toISOString().substr(11,8)}function r(){var a=(m+t/b.motionBlurFrames)*(1E3/b.framerate);l=C+a;E=D+a;K.forEach(function(b){b._hookedTime=a/1E3});s();k("Frame: "+m+" "+t);for(var d=0;d<p.length;d++)l>=p[d].triggerTime&&(v(p[d].callback,0,void 0),p.splice(d,1));for(d=0;d<q.length;d++)l>=
q[d].triggerTime&&(v(q[d].callback,0,void 0),q[d].triggerTime+=q[d].time);F.forEach(function(a){v(a,0,l-V)});F=[]}function L(a){a||(a=function(a){download(a,g.filename+g.extension,g.mimeType);return!1});g.save(a)}function k(a){M&&console.log(a)}function z(a){var b=N[a];b&&b.apply(null,Array.prototype.slice.call(arguments,1))}var b=a||{},M,l,C,E,D,g,p=[],q=[],m=0,t=0,F=[],G=!1,N={};b.framerate=b.framerate||60;b.motionBlurFrames=2*(b.motionBlurFrames||1);M=b.verbose||!1;b.step=1E3/b.framerate;b.timeLimit=
b.timeLimit||0;b.frameLimit=b.frameLimit||0;b.startTime=b.startTime||0;var i=document.createElement("div");i.style.position="absolute";i.style.left=i.style.top=0;i.style.backgroundColor="black";i.style.fontFamily="monospace";i.style.fontSize="11px";i.style.padding="5px";i.style.color="red";i.style.zIndex=1E5;b.display&&document.body.appendChild(i);var h=document.createElement("canvas"),w=h.getContext("2d"),f,u;k("Step is set to "+b.step+"ms");var a={gif:y,webm:n,ffmpegserver:o,png:A,jpg:B,"webm-mediarecorder":x},
O=a[b.format];if(!O)throw"Error: Incorrect or missing format: Valid formats are "+Object.keys(a).join(", ");g=new O(b);g.step=J;g.on("process",r);g.on("progress",function(a){z("progress",a)});!1=="performance"in window&&(window.performance={});Date.now=Date.now||function(){return(new Date).getTime()};if(!1=="now"in window.performance){var P=Date.now();performance.timing&&performance.timing.navigationStart&&(P=performance.timing.navigationStart);window.performance.now=function(){return Date.now()-
P}}var v=window.setTimeout,H=window.setInterval,Q=window.clearTimeout,R=window.requestAnimationFrame,T=window.Date.now,U=window.performance.now,S=window.Date.prototype.getTime,K=[];return{start:function(){c();g.start();G=!0},capture:function(a){if(G)if(2<b.motionBlurFrames){if(h.width!==a.width||h.height!==a.height)h.width=a.width,h.height=a.height,f=new Uint16Array(4*h.height*h.width),w.fillStyle="#0",w.fillRect(0,0,h.width,h.height);w.drawImage(a,0,0);u=w.getImageData(0,0,h.width,h.height);for(a=
0;a<f.length;a+=4)f[a]+=u.data[a],f[a+1]+=u.data[a+1],f[a+2]+=u.data[a+2];t++;if(t>=0.5*b.motionBlurFrames){for(var a=u.data,d=0;d<f.length;d+=4)a[d]=2*f[d]/b.motionBlurFrames,a[d+1]=2*f[d+1]/b.motionBlurFrames,a[d+2]=2*f[d+2]/b.motionBlurFrames;w.putImageData(u,0,0);g.add(h);m++;t=0;k("Full MB Frame! "+m+" "+l);for(d=0;d<f.length;d+=4)f[d]=0,f[d+1]=0,f[d+2]=0;gc()}else J()}else g.add(a),m++,k("Full Frame! "+m)},stop:e,save:L,on:function(a,b){N[a]=b}}}var H="object"==typeof self&&self.self===self&&
self||"object"==typeof global&&global.global===global&&global||this;"gc"in window||(window.gc=function(){});HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(a,c,e){for(var e=atob(this.toDataURL(c,e).split(",")[1]),n=e.length,o=new Uint8Array(n),r=0;r<n;r++)o[r]=e.charCodeAt(r);a(new Blob([o],{type:c||"image/png"}))}});(function(){!1=="performance"in window&&(window.performance={});Date.now=Date.now||function(){return(new Date).getTime()};
if(!1=="now"in window.performance){var a=Date.now();performance.timing&&performance.timing.navigationStart&&(a=performance.timing.navigationStart);window.performance.now=function(){return Date.now()-a}}})();var V=window.Date.now();c.prototype.start=function(){};c.prototype.stop=function(){};c.prototype.add=function(){};c.prototype.save=function(){};c.prototype.dispose=function(){};c.prototype.safeToProceed=function(){return!0};c.prototype.step=function(){console.log("Step not set!")};e.prototype=
Object.create(c.prototype);e.prototype.start=function(){this.dispose()};e.prototype.add=function(a){var c=new FileReader;c.onload=function(){this.tape.append(("0000000"+this.count).slice(-7)+this.fileExtension,new Uint8Array(c.result));this.count++;this.step()}.bind(this);c.readAsArrayBuffer(a)};e.prototype.save=function(a){a(this.tape.save())};e.prototype.dispose=function(){this.tape=new Tar;this.count=0};A.prototype=Object.create(e.prototype);A.prototype.add=function(a){a.toBlob(function(a){e.prototype.add.call(this,
a)}.bind(this),this.type)};B.prototype=Object.create(e.prototype);B.prototype.add=function(a){a.toBlob(function(a){e.prototype.add.call(this,a)}.bind(this),this.type,this.quality)};n.prototype=Object.create(c.prototype);n.prototype.start=function(){this.dispose()};n.prototype.add=function(a){this.frames.push(a.toDataURL("image/webp",this.quality));0<this.settings.autoSaveTime&&this.frames.length/this.settings.framerate>=this.settings.autoSaveTime?this.save(function(a){this.filename=this.baseFilename+
"-part-"+("0000000"+this.part).slice(-7);download(a,this.filename+this.extension,this.mimeType);this.dispose();this.part++;this.filename=this.baseFilename+"-part-"+("0000000"+this.part).slice(-7);this.step()}.bind(this)):this.step()};n.prototype.save=function(a){if(this.frames.length){var c=Whammy.fromImageArray(this.frames,this.settings.framerate),c=new Blob([c],{type:"octet/stream"});a(c)}};n.prototype.dispose=function(){this.frames=[]};o.prototype=Object.create(c.prototype);o.prototype.start=function(){this.encoder.start(this.settings)};
o.prototype.add=function(a){this.encoder.add(a)};o.prototype.save=function(a){this.callback=a;this.encoder.end()};o.prototype.safeToProceed=function(){return this.encoder.safeToProceed()};x.prototype=Object.create(c.prototype);x.prototype.add=function(a){this.stream||(this.stream=a.captureStream(this.framerate),this.mediaRecorder=new MediaRecorder(this.stream),this.mediaRecorder.start(),this.mediaRecorder.ondataavailable=function(a){this.chunks.push(a.data)}.bind(this));this.step()};x.prototype.save=
function(a){this.mediaRecorder.onstop=function(){var c=new Blob(this.chunks,{type:"video/webm"});this.chunks=[];a(c)}.bind(this);this.mediaRecorder.stop()};y.prototype=Object.create(c.prototype);y.prototype.add=function(a){this.sizeSet||(this.encoder.setOption("width",a.width),this.encoder.setOption("height",a.height),this.sizeSet=!0);this.canvas.width=a.width;this.canvas.height=a.height;this.ctx.drawImage(a,0,0);this.encoder.addFrame(this.ctx,{copy:!0,delay:this.settings.step});this.step()};y.prototype.save=
function(a){this.callback=a;this.encoder.render()};"undefined"!=typeof exports&&!exports.nodeType?("undefined"!=typeof module&&!module.nodeType&&module.exports&&(exports=module.exports=s),exports.CCapture=s):H.CCapture=s;"function"==typeof define&&define.amd&&define("CCapture",[],function(){return s})})();
